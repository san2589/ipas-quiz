<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f766e" />
  <meta name="description" content="iPAS 測驗 Web App" />
  <title>iPAS 測驗</title>

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./icon.png" />

  <style>
    :root { --bg:#0b1220; --card:#121a2a; --muted:#94a3b8; --text:#e5e7eb; --brand:#14b8a6; --danger:#ef4444; --ok:#22c55e; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial;
          background:linear-gradient(180deg,#071023,#0b1220 40%); color:var(--text); }
    .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 0; }
    .brand{ font-weight:900; letter-spacing:.5px; }
    .pill{ font-size:12px; color:#b6c2d6; background:rgba(148,163,184,.12); border:1px solid rgba(148,163,184,.22);
          padding:6px 10px; border-radius:999px; display:inline-flex; gap:8px; align-items:center; }
    .card{ background:rgba(18,26,42,.92); border:1px solid rgba(148,163,184,.18);
          border-radius:16px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.28); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .grid{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width: 920px){ .grid{ grid-template-columns: 1.25fr .75fr; } }

    .muted{ color:var(--muted); }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
          font-size:12px; padding:2px 6px; border-radius:8px; border:1px solid rgba(148,163,184,.25); background:rgba(2,6,23,.35); color:#d6dee9; }
    .btn{ appearance:none; border:0; border-radius:12px; padding:10px 12px; cursor:pointer;
          background:rgba(20,184,166,.14); color:#c7fff6; border:1px solid rgba(20,184,166,.45); font-weight:800; }
    .btn:hover{ filter:brightness(1.05); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .btn2{ background:rgba(148,163,184,.12); border:1px solid rgba(148,163,184,.28); color:#e5e7eb; font-weight:800; }
    .btnDanger{ background:rgba(239,68,68,.14); border:1px solid rgba(239,68,68,.45); color:#ffd2d2; font-weight:900; }
    .btnOk{ background:rgba(34,197,94,.12); border:1px solid rgba(34,197,94,.45); color:#d6ffe2; font-weight:900; }

    .progress{ height:10px; background:rgba(148,163,184,.14); border-radius:999px; overflow:hidden; border:1px solid rgba(148,163,184,.18); }
    .bar{ height:100%; width:0%; background:linear-gradient(90deg, rgba(20,184,166,.85), rgba(34,197,94,.85)); }

    .opt{
      width:100%;
      text-align:left;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.35);
      color:var(--text);
      cursor:pointer;

      font-size:clamp(18px, 4.6vw, 20px);
      line-height:1.6;
    }

    .opt:hover{ border-color:rgba(20,184,166,.6); }
    .opt.selected{ outline:2px solid rgba(20,184,166,.8); border-color:rgba(20,184,166,.8); }
    .opt.correct{ outline:2px solid rgba(34,197,94,.85); border-color:rgba(34,197,94,.85); }
    .opt.wrong{ outline:2px solid rgba(239,68,68,.9); border-color:rgba(239,68,68,.9); }

    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; padding:10px 12px;
            background:rgba(2,6,23,.82); border:1px solid rgba(148,163,184,.25); border-radius:12px; color:#e5e7eb;
            max-width: 92vw; box-shadow: 0 10px 30px rgba(0,0,0,.35); display:none; z-index:9998; }

    .divider{ height:1px; background:rgba(148,163,184,.18); margin:12px 0; }

    .miniGrid{ display:grid; grid-template-columns: repeat(10, minmax(0, 1fr)); gap:6px; }
    @media (max-width: 520px){ .miniGrid{ grid-template-columns: repeat(8, minmax(0, 1fr)); } }
    .qdot{
      border-radius:10px; padding:6px 0; text-align:center; font-size:12px;
      border:1px solid rgba(148,163,184,.22); background:rgba(2,6,23,.35); color:#d6dee9;
      cursor:pointer; user-select:none;
    }
    .qdot.active{ outline:2px solid rgba(20,184,166,.7); }
    .qdot.ok{ border-color: rgba(34,197,94,.6); background: rgba(34,197,94,.10); color:#d6ffe2; }
    .qdot.bad{ border-color: rgba(239,68,68,.7); background: rgba(239,68,68,.10); color:#ffd2d2; }
    .qdot.na{ border-color: rgba(148,163,184,.28); background: rgba(148,163,184,.10); color:#d6dee9; opacity:.9; }
  </style>
</head>

<div id="fatal" style="display:none;position:fixed;left:12px;right:12px;bottom:12px;z-index:9999;
background:#2b0b0b;color:#ffd9d9;border:1px solid #ff6b6b;border-radius:12px;padding:10px;
font:12px/1.4 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;white-space:pre-wrap;">
</div>

<script>
(function(){
  var box = document.getElementById('fatal');
  function show(msg){
    if(!box) return;
    box.style.display = 'block';
    box.textContent = msg;
  }
  window.addEventListener('error', function(e){
    var msg = "JS Error:\n" +
      (e && e.message ? e.message : String(e)) + "\n" +
      (e && e.filename ? e.filename : "") + ":" +
      (e && e.lineno ? e.lineno : "") + ":" +
      (e && e.colno ? e.colno : "");
    show(msg);
  });
  window.addEventListener('unhandledrejection', function(e){
    var r = (e && e.reason) ? e.reason : e;
    var text = (r && r.message) ? r.message : String(r);
    show("Promise Rejection:\n" + text);
  });
  window.__showFatal = show;
})();
</script>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="brand">iPAS 測驗</div>
        <div class="muted" style="font-size:12px;">一次到位版：成績分析 + 考試倒數 + 錯題本</div>
      </div>
      <div class="pill" id="statusPill">
        <span id="statusText">初始化中…</span>
        <span class="kbd" id="timerText" style="display:none;">--:--</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row" style="align-items:center; justify-content:space-between;">
          <div class="muted" style="font-size:13px;">
            題庫：<span class="kbd" id="qSource">./ipas_questions_all.json</span>
            <span style="margin-left:8px;">版本：<span class="kbd" id="appVer"></span></span>
            <span style="margin-left:8px;">本回合：<span class="kbd" id="sessionText">一般</span></span>
          </div>
          <div class="row">
            <button class="btn2 btn" id="btnRetry" style="display:none;">重新載入題庫</button>
            <button class="btnDanger btn" id="btnReset">清除進度</button>
          </div>
        </div>

        <div style="margin:12px 0;">
          <div class="progress"><div class="bar" id="bar"></div></div>
          <div class="row" style="justify-content:space-between; margin-top:8px;">
            <div class="muted" id="progressText">0 / 0</div>
            <div class="muted" id="scoreText">正確 0・錯誤 0・未作答 0</div>
          </div>
        </div>

        <div id="questionArea" style="margin-top:10px;">
          <div class="muted">載入題庫中…</div>
        </div>

        <div class="row" style="margin-top:14px; justify-content:space-between;">
          <button class="btn2 btn" id="btnPrev" disabled>上一題</button>
          <div class="row">
            <button class="btn2 btn" id="btnReveal" disabled>看答案</button>
            <button class="btn2 btn" id="btnSubmit" disabled>交卷</button>
            <button class="btn" id="btnNext" disabled>下一題</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:900; margin-bottom:10px;">設定 / 工具</div>

        <label style="display:block; margin:10px 0 6px;" class="muted">模式</label>
        <div class="row">
          <button class="btn2 btn" id="modePractice">練習模式</button>
          <button class="btn2 btn" id="modeExam">考試模式</button>
        </div>

        <div class="row" style="margin-top:10px; align-items:center;">
          <span class="muted">考試時間：</span>
          <button class="btn2 btn" id="btnT60">60 分</button>
          <button class="btn2 btn" id="btnT90">90 分</button>
          <button class="btn2 btn" id="btnT120">120 分</button>
        </div>
        <div class="muted" style="font-size:12px; margin-top:6px;">
          考試模式會啟用倒數；時間到會自動交卷。練習模式不倒數。
        </div>

        <div class="divider"></div>

        <label style="display:block; margin:8px 0 6px;" class="muted">題目順序</label>
        <div class="row">
          <button class="btn2 btn" id="btnShuffle">隨機洗牌</button>
          <button class="btn2 btn" id="btnOrdered">照原順序</button>
        </div>

        <div class="divider"></div>

        <label style="display:block; margin:8px 0 6px;" class="muted">錯題本</label>
        <div class="row">
          <button class="btnOk btn" id="btnStartWrong">重測錯題</button>
          <button class="btn2 btn" id="btnClearWrong">清除錯題本</button>
        </div>
        <div class="muted" style="font-size:12px; margin-top:6px;">
          交卷後會把「答錯 + 未作答」加入錯題本。重測錯題會優先抽錯題，不足會用一般題補滿 80 題。
        </div>

        <div class="divider"></div>

        <label style="display:block; margin:8px 0 6px;" class="muted">成績分析</label>
        <div class="row">
          <button class="btn2 btn" id="btnShowAll">全部</button>
          <button class="btn2 btn" id="btnShowWrong">只看錯題</button>
          <button class="btn2 btn" id="btnShowUnanswered">只看未作答</button>
        </div>

        <div style="margin-top:10px;">
          <div class="muted" style="margin-bottom:8px;">題目導覽（交卷後會標色）</div>
          <div id="navGrid" class="miniGrid"></div>
        </div>

        <div class="divider"></div>

        <label style="display:block; margin:8px 0 6px;" class="muted">快捷鍵</label>
        <div class="muted" style="line-height:1.7;">
          <span class="kbd">←</span>/<span class="kbd">→</span> 上一題/下一題<br/>
          <span class="kbd">1-9</span> 選項作答<br/>
          <span class="kbd">A</span> 看答案<br/>
          <span class="kbd">S</span> 交卷
        </div>

        <div style="margin-top:14px;" class="muted">
          若你有 <span class="kbd">sw.js</span>，此版會自動註冊離線快取（存在才註冊，不存在不報錯）。
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  // ========= Config =========
  const APP_VERSION = "1.0.0-ipas";
  const QUESTIONS_URL = "./ipas_questions_all.json";
  const PICK_COUNT = 50;
  const POINT_PER_Q = 2;
  const PASS_SCORE = 70;
  const FETCH_TIMEOUT_MS = 12000;

  // ========= Storage Keys (ipas_ prefix) =========
  const LS_STATE = "ipas_quiz_state_v1";
  const LS_QCACHE = "ipas_questions_cache_v1";
  const LS_LAST_SCORE = "ipas_last_score_v1";
  const LS_WRONG = "ipas_wrongbook_v1";
  const LS_DRAW_NORMAL = "ipas_draw_normal_v1";
  const LS_DRAW_WRONG  = "ipas_draw_wrong_v1";

  // ========= DOM =========
  const elStatusPill = document.getElementById("statusPill");
  const elStatusText = document.getElementById("statusText");
  const elTimerText = document.getElementById("timerText");
  const elQSource = document.getElementById("qSource");
  const elAppVer = document.getElementById("appVer");
  const elSessionText = document.getElementById("sessionText");
  const elBar = document.getElementById("bar");
  const elProgress = document.getElementById("progressText");
  const elScore = document.getElementById("scoreText");
  const elArea = document.getElementById("questionArea");
  const elToast = document.getElementById("toast");
  const elNav = document.getElementById("navGrid");

  const btnPrev = document.getElementById("btnPrev");
  const btnNext = document.getElementById("btnNext");
  const btnReveal = document.getElementById("btnReveal");
  const btnSubmit = document.getElementById("btnSubmit");
  const btnReset = document.getElementById("btnReset");
  const btnRetry = document.getElementById("btnRetry");

  const btnShuffle = document.getElementById("btnShuffle");
  const btnOrdered = document.getElementById("btnOrdered");

  const modePractice = document.getElementById("modePractice");
  const modeExam = document.getElementById("modeExam");

  const btnT60 = document.getElementById("btnT60");
  const btnT90 = document.getElementById("btnT90");
  const btnT120 = document.getElementById("btnT120");

  const btnStartWrong = document.getElementById("btnStartWrong");
  const btnClearWrong = document.getElementById("btnClearWrong");

  const btnShowAll = document.getElementById("btnShowAll");
  const btnShowWrong = document.getElementById("btnShowWrong");
  const btnShowUnanswered = document.getElementById("btnShowUnanswered");

  elQSource.textContent = QUESTIONS_URL;
  elAppVer.textContent = APP_VERSION;

  // ========= State =========
  const defaultState = () => ({
    version: APP_VERSION,
    mode: "exam",
    order: "ordered",
    seed: null,
    idx: 0,
    answers: {},
    reveal: {},
    submitted: false,
    examDurationSec: 90 * 60,
    examStartAt: null,
    session: "normal",
    filter: "all"
  });

  let state = loadState();

  let bank = [];
  let questions = [];
  let viewOrder = [];
  let bankSize = 0;

  let timerHandle = null;

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_STATE);
      if(!raw) return defaultState();
      const obj = JSON.parse(raw);
      return { ...defaultState(), ...obj };
    }catch{
      return defaultState();
    }
  }
  function saveState(){ localStorage.setItem(LS_STATE, JSON.stringify(state)); }

  function toast(msg){
    elToast.textContent = msg;
    elToast.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> elToast.style.display="none", 2000);
  }

  function setStatus(text, kind){
    elStatusText.textContent = text;
    if(kind === "ok"){
      elStatusPill.style.background = "rgba(34,197,94,.14)";
      elStatusPill.style.borderColor = "rgba(34,197,94,.45)";
      elStatusPill.style.color = "#d6ffe2";
    } else if(kind === "err"){
      elStatusPill.style.background = "rgba(239,68,68,.14)";
      elStatusPill.style.borderColor = "rgba(239,68,68,.45)";
      elStatusPill.style.color = "#ffd2d2";
    } else {
      elStatusPill.style.background = "rgba(148,163,184,.12)";
      elStatusPill.style.borderColor = "rgba(148,163,184,.22)";
      elStatusPill.style.color = "#b6c2d6";
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function withTimeout(fetcher, ms){
    const controller = new AbortController();
    const t = setTimeout(()=>controller.abort(), ms);
    const wrapped = fetcher(controller.signal).finally(()=>clearTimeout(t));
    return { wrapped };
  }

  async function fetchQuestions(){
    const url = new URL(QUESTIONS_URL, location.href);
    url.searchParams.set("v", APP_VERSION);
    const { wrapped } = withTimeout(async (signal) => {
      const res = await fetch(url.toString(), { cache:"no-store", signal });
      if(!res.ok) throw new Error("HTTP " + res.status);
      return res.json();
    }, FETCH_TIMEOUT_MS);

    const data = await wrapped;
    try{ localStorage.setItem(LS_QCACHE, JSON.stringify({ savedAt: Date.now(), data })); }catch{}
    return data;
  }

  function loadCachedQuestions(){
    try{
      const raw = localStorage.getItem(LS_QCACHE);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      return obj?.data ?? null;
    }catch{
      return null;
    }
  }

  function normalizeQuestions(raw){
    if(!Array.isArray(raw)) throw new Error("題庫格式不是陣列(Array)");

    return raw.map((q, i) => {
      const id = q.id ?? q.qid ?? q.no ?? (i + 1);

      let title = (q.q ?? q.question ?? q.title ?? "").toString();
      title = title.replace(/^\s*\d+\s*[.)、．]\s*/, "");

      const options = q.a ?? q.options ?? q.choices ?? q.items ?? [];

      const ansRaw = q.c ?? q.answer ?? q.correct ?? null;
      let ansIndex = null;

      if(typeof ansRaw === "number"){
        if(Number.isInteger(ansRaw)){
          if(ansRaw >= 1 && ansRaw <= options.length) ansIndex = ansRaw - 1;
          else if(ansRaw >= 0 && ansRaw < options.length) ansIndex = ansRaw;
        }
      } else if(typeof ansRaw === "string"){
        const t = ansRaw.trim().toUpperCase();
        const n = Number(t);
        if(Number.isInteger(n) && n >= 1 && n <= options.length) ansIndex = n - 1;
        else {
          const code = t.charCodeAt(0) - 65;
          if(code >= 0 && code < options.length) ansIndex = code;
        }
      }

      return { id, title, options, ansIndex };
    });
  }

  function mulberry32(seed){
    return function() {
      let t = seed += 0x6D2B79F5;
      t = Math.imul(t ^ t >>> 15, t | 1);
      t ^= t + Math.imul(t ^ t >>> 7, t | 61);
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
  }

  function buildViewOrder(){
    const n = questions.length;
    const arr = [...Array(n).keys()];
    if(state.order === "shuffled"){
      if(!state.seed) state.seed = (Date.now() >>> 0);
      const rnd = mulberry32(state.seed >>> 0);
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(rnd() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }
    viewOrder = arr;
    if(state.idx < 0) state.idx = 0;
    if(state.idx > viewOrder.length - 1) state.idx = Math.max(0, viewOrder.length - 1);
    saveState();
  }

  function currentQuestion(){
    if(!questions.length) return null;
    return questions[viewOrder[state.idx]];
  }

  function loadWrongBook(){
    try{
      const raw = localStorage.getItem(LS_WRONG);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function saveWrongBook(ids){
    const uniq = Array.from(new Set(ids));
    localStorage.setItem(LS_WRONG, JSON.stringify(uniq));
  }

  function loadLastScore(){
    try{
      const raw = localStorage.getItem(LS_LAST_SCORE);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch{ return null; }
  }

  function computeResult(){
    let correct = 0;
    let answered = 0;

    for(const q of questions){
      const a = state.answers[q.id];
      if(a === undefined) continue;
      answered++;
      if(q.ansIndex !== null && a === q.ansIndex) correct++;
    }

    const wrong = answered - correct;
    const unanswered = questions.length - answered;
    const score = Math.round((correct * POINT_PER_Q) * 100) / 100;
    const pass = score >= PASS_SCORE;

    return { correct, wrong, unanswered, answered, total: questions.length, score, pass };
  }

  function updateTop(){
    const q = currentQuestion();
    const total = questions.length || 0;
    const cur = total ? state.idx + 1 : 0;
    const qid = q?.id ?? "-";

    elProgress.textContent = `第 ${cur} / ${total} 題（題庫ID：${qid}，題庫共 ${bankSize || 0} 題）`;
    elBar.style.width = total ? `${(cur / total) * 100}%` : "0%";

    const r = computeResult();
    const last = loadLastScore();
    const lastText = last ? `｜上次得分 ${last.score} 分（${last.pass ? "及格" : "未及格"}）` : "";
    elScore.textContent = `正確 ${r.correct}・錯誤 ${r.wrong}・未作答 ${r.unanswered}${lastText}`;

    elSessionText.textContent = (state.session === "wrong") ? "錯題重測" : "一般";
  }

  function getWrongIdsFromThisSession(){
    const ids = [];
    for(const q of questions){
      const a = state.answers[q.id];
      if(a === undefined) continue;
      if(q.ansIndex !== null && a !== q.ansIndex) ids.push(q.id);
    }
    return ids;
  }
  function getUnansweredIdsFromThisSession(){
    const ids = [];
    for(const q of questions){
      const a = state.answers[q.id];
      if(a === undefined) ids.push(q.id);
    }
    return ids;
  }

  function buildNavGrid(){
    const filter = state.filter;
    const wrongSet = new Set(getWrongIdsFromThisSession());
    const unansweredSet = new Set(getUnansweredIdsFromThisSession());

    elNav.innerHTML = questions.map((q, i) => {
      const n = i + 1;
      const isActive = (viewOrder[state.idx] === i);

      const a = state.answers[q.id];
      const answered = a !== undefined;
      const ok = answered && (q.ansIndex !== null && a === q.ansIndex);
      const bad = answered && !ok;

      let cls = "qdot";
      if(isActive) cls += " active";
      if(state.submitted){
        if(ok) cls += " ok";
        else if(bad) cls += " bad";
        else cls += " na";
      }

      if(filter === "wrong" && !wrongSet.has(q.id)) return "";
      if(filter === "unanswered" && !unansweredSet.has(q.id)) return "";

      return `<div class="${cls}" data-nav="${i}" title="第${n}題">${n}</div>`;
    }).join("");

    elNav.querySelectorAll("[data-nav]").forEach(d => {
      d.addEventListener("click", () => {
        const i = parseInt(d.getAttribute("data-nav"), 10);
        const pos = viewOrder.indexOf(i);
        if(pos >= 0){
          state.idx = pos;
          saveState();
          render();
        }
      });
    });
  }

  function render(){
    const q = currentQuestion();
    updateTop();

    const total = questions.length;
    btnPrev.disabled = !q || state.idx === 0;
    btnNext.disabled = !q || state.idx === total - 1;
    btnSubmit.disabled = !q;

    const revealAllowed = (state.mode === "practice") || state.submitted;
    btnReveal.disabled = !q || !revealAllowed;

    if(!q){
      elArea.innerHTML = `<div class="muted">尚未載入題庫</div>`;
      return;
    }

    const chosen = state.answers[q.id];
    const isRevealed = !!state.reveal[q.id];
    const correct = q.ansIndex;
    const canAnswer = !state.submitted;

    const optHtml = q.options.map((text, i) => {
      let cls = "opt";
      const isSel = chosen === i;
      if(isSel) cls += " selected";

      if(isRevealed && correct !== null){
        if(i === correct) cls += " correct";
        else if(isSel && i !== correct) cls += " wrong";
      }

      const label = String.fromCharCode(65 + i);
      const disabledAttr = canAnswer ? "" : "disabled";
      return `
        <button class="${cls}" data-opt="${i}" ${disabledAttr}>
          <div style="display:flex; gap:10px; align-items:flex-start;">
            <div class="kbd">${label}</div>
            <div style="line-height:1.5;">${escapeHtml(String(text))}</div>
          </div>
        </button>
      `;
    }).join("");

    const hint = (state.mode === "exam")
      ? `<div class="muted" style="margin-top:10px;">考試模式：交卷前不可看答案；倒數結束會自動交卷。</div>`
      : `<div class="muted" style="margin-top:10px;">練習模式：可隨時看答案。</div>`;

    const ansLine = (isRevealed && correct !== null)
      ? `<div style="margin-top:12px;"><span class="pill">正確答案：${String.fromCharCode(65 + correct)}</span></div>`
      : "";

    const resultCard = (() => {
      if(!state.submitted) return "";
      const r = computeResult();
      const border = r.pass ? "rgba(34,197,94,.45)" : "rgba(239,68,68,.45)";
      const bg = r.pass ? "rgba(34,197,94,.10)" : "rgba(239,68,68,.10)";
      const color = r.pass ? "#d6ffe2" : "#ffd2d2";
      return `
        <div style="margin-top:14px; padding:14px; border-radius:14px; border:1px solid ${border}; background:${bg}; color:${color};">
          <div style="font-weight:900; font-size:16px;">交卷完成</div>
          <div style="margin-top:6px;">得分：<b>${r.score.toFixed(2)}</b> 分（${r.pass ? "✅及格" : "❌未及格"}）</div>
          <div style="margin-top:4px;">正確：${r.correct}/${r.total}　錯誤：${r.wrong}　未作答：${r.unanswered}</div>
          <div class="muted" style="margin-top:8px; color:#b6c2d6;">交卷後已鎖定作答；如需重測請按「清除進度」或「重測錯題」。</div>
        </div>
      `;
    })();

    elArea.innerHTML = `
      <div style="font-size:18px; font-weight:900; line-height:1.5;">
        <span class="pill" style="margin-right:8px;">題庫ID：${escapeHtml(String(q.id))}</span>
        ${escapeHtml(q.title)}
      </div>
      <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">${optHtml}</div>
      ${ansLine}
      ${hint}
      ${resultCard}
    `;

    elArea.querySelectorAll("[data-opt]").forEach(btn => {
      btn.addEventListener("click", () => onChoose(parseInt(btn.getAttribute("data-opt"), 10)));
    });

    buildNavGrid();
  }

  function onChoose(optIndex){
    if(state.submitted) return;
    const q = currentQuestion();
    if(!q) return;
    if(optIndex < 0 || optIndex >= q.options.length) return;

    state.answers[q.id] = optIndex;
    saveState();
    render();
  }

  function reveal(){
    const q = currentQuestion();
    if(!q) return;
    const revealAllowed = (state.mode === "practice") || state.submitted;
    if(!revealAllowed) return;

    state.reveal[q.id] = true;
    saveState();
    render();
  }

  function prev(){ if(state.idx > 0){ state.idx--; saveState(); render(); } }
  function next(){ if(state.idx < questions.length - 1){ state.idx++; saveState(); render(); } }

  function formatMMSS(sec){
    sec = Math.max(0, Math.floor(sec));
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
  }
  function stopTimer(){
    if(timerHandle){ clearInterval(timerHandle); timerHandle = null; }
    elTimerText.style.display = "none";
  }
  function startTimerIfNeeded(){
    stopTimer();
    if(state.mode !== "exam") return;
    if(state.submitted) return;

    if(!state.examStartAt) state.examStartAt = Date.now();
    saveState();

    elTimerText.style.display = "inline-flex";

    const tick = () => {
      const elapsed = (Date.now() - state.examStartAt) / 1000;
      const remain = state.examDurationSec - elapsed;
      elTimerText.textContent = formatMMSS(remain);

      if(remain <= 60) setStatus("倒數中（即將到時）", "err");
      else setStatus("考試中", "info");

      if(remain <= 0){
        stopTimer();
        submitNow(true);
      }
    };

    tick();
    timerHandle = setInterval(tick, 500);
  }
  function setExamDuration(min){
    state.examDurationSec = min * 60;
    state.examStartAt = null;
    saveState();
    toast(`考試時間：${min} 分鐘`);
    startTimerIfNeeded();
  }

  function submitNow(auto=false){
    if(!questions.length) return;
    if(state.submitted){
      toast("已交卷");
      render();
      return;
    }

    state.submitted = true;
    saveState();

    const r = computeResult();
    localStorage.setItem(LS_LAST_SCORE, JSON.stringify({
      score: r.score,
      correct: r.correct,
      wrong: r.wrong,
      unanswered: r.unanswered,
      total: r.total,
      pass: r.pass,
      at: Date.now(),
      session: state.session
    }));

    const wrongIds = [];
    for(const q of questions){
      const a = state.answers[q.id];
      if(a === undefined) wrongIds.push(q.id);
      else if(q.ansIndex !== null && a !== q.ansIndex) wrongIds.push(q.id);
    }
    const wb = loadWrongBook();
    saveWrongBook(wb.concat(wrongIds));

    stopTimer();
    setStatus(auto ? "時間到，自動交卷" : "交卷完成", r.pass ? "ok" : "err");
    toast(`${auto ? "自動交卷" : "交卷完成"}：${r.score.toFixed(2)} 分（${r.pass ? "及格" : "未及格"}）`);
    render();
  }

  function setMode(m){
    state.mode = m;
    if(m === "exam"){
      if(!state.submitted) state.examStartAt = null;
    } else {
      state.examStartAt = null;
    }
    saveState();

    modePractice.classList.toggle("btn", m === "practice");
    modeExam.classList.toggle("btn", m === "exam");

    toast(m === "exam" ? "切換：考試模式" : "切換：練習模式");
    startTimerIfNeeded();
    render();
  }

  function setOrder(order){
    state.order = order;
    if(order === "ordered") state.seed = null;
    buildViewOrder();

    btnShuffle.classList.toggle("btn", order === "shuffled");
    btnOrdered.classList.toggle("btn", order === "ordered");

    toast(order === "shuffled" ? "題目已洗牌" : "題目恢復原順序");
    render();
  }

  function setFilter(f){
    state.filter = f;
    saveState();

    btnShowAll.classList.toggle("btn", f === "all");
    btnShowWrong.classList.toggle("btn", f === "wrong");
    btnShowUnanswered.classList.toggle("btn", f === "unanswered");

    toast(f === "all" ? "顯示：全部" : f === "wrong" ? "顯示：只看錯題" : "顯示：只看未作答");
    buildNavGrid();
  }

  function pickIdsCrypto(ids){
    const arr = ids.slice();
    for(let i = arr.length - 1; i > 0; i--){
      const r = crypto.getRandomValues(new Uint32Array(1))[0];
      const j = r % (i + 1);
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function startNewSession(sessionType){
    state.session = sessionType;
    state.idx = 0;
    state.answers = {};
    state.reveal = {};
    state.submitted = false;
    state.seed = null;
    state.examStartAt = null;
    saveState();
  }

  function buildQuestionsFromDraw(drawIds){
    const map = new Map(bank.map(q => [q.id, q]));
    questions = drawIds.map(id => map.get(id)).filter(Boolean);
  }

  function drawNormal(){
    let drawIds = null;
    try { drawIds = JSON.parse(localStorage.getItem(LS_DRAW_NORMAL) || "null"); } catch { drawIds = null; }

    if(!Array.isArray(drawIds) || drawIds.length !== PICK_COUNT){
      const ids = bank.map(q => q.id);
      drawIds = pickIdsCrypto(ids).slice(0, PICK_COUNT);
      localStorage.setItem(LS_DRAW_NORMAL, JSON.stringify(drawIds));
    }
    buildQuestionsFromDraw(drawIds);

    if(questions.length !== PICK_COUNT){
      localStorage.removeItem(LS_DRAW_NORMAL);
      return drawNormal();
    }
  }

  function drawWrong(){
    const wrongBook = loadWrongBook();
    if(!wrongBook.length){
      toast("錯題本是空的");
      return false;
    }

    const wrongIds = pickIdsCrypto(wrongBook);
    const taken = new Set(wrongIds);
    const filler = bank.map(q => q.id).filter(id => !taken.has(id));
    const filled = wrongIds.concat(pickIdsCrypto(filler));
    const drawIds = filled.slice(0, PICK_COUNT);

    localStorage.setItem(LS_DRAW_WRONG, JSON.stringify(drawIds));
    buildQuestionsFromDraw(drawIds);

    if(questions.length !== PICK_COUNT){
      localStorage.removeItem(LS_DRAW_WRONG);
      toast("錯題重測抽題失敗，請再試一次");
      return false;
    }
    return true;
  }

  function resetProgress(){
    localStorage.removeItem(LS_STATE);
    localStorage.removeItem(LS_DRAW_NORMAL);
    localStorage.removeItem(LS_DRAW_WRONG);
    localStorage.removeItem(LS_LAST_SCORE);
    toast("已清除進度，將重新抽題");
    location.reload();
  }

  function clearWrongBook(){
    localStorage.removeItem(LS_WRONG);
    toast("已清除錯題本");
  }

  async function init(){
    try{
      setStatus("載入題庫…", "info");
      btnRetry.style.display = "none";

      let raw;
      try{
        raw = await fetchQuestions();
        setStatus("題庫已更新", "ok");
      }catch(err){
        const cached = loadCachedQuestions();
        if(cached){
          raw = cached;
          setStatus("離線備援題庫", "ok");
          toast("網路讀取失敗，改用本機備援題庫");
        } else {
          throw err;
        }
      }

      bank = normalizeQuestions(raw);
      bankSize = bank.length;

      if(state.session === "wrong"){
        const ok = drawWrong();
        if(!ok){
          state.session = "normal";
          saveState();
          drawNormal();
        }
      } else {
        drawNormal();
      }

      buildViewOrder();

      modePractice.classList.toggle("btn", state.mode === "practice");
      modeExam.classList.toggle("btn", state.mode === "exam");
      btnShuffle.classList.toggle("btn", state.order === "shuffled");
      btnOrdered.classList.toggle("btn", state.order === "ordered");

      setFilter(state.filter);

      btnPrev.disabled = false;
      btnNext.disabled = false;
      btnReveal.disabled = false;
      btnSubmit.disabled = false;

      render();
      startTimerIfNeeded();

      if("serviceWorker" in navigator){
        navigator.serviceWorker.register("./sw.js").catch(()=>{});
      }

    }catch(err){
      console.error(err);
      setStatus("載入失敗", "err");
      btnRetry.style.display = "inline-block";
      const msg = (err && err.message) ? err.message : String(err);
      elArea.innerHTML = `
        <div style="font-weight:900; font-size:16px; color:#ffd2d2;">題庫載入失敗</div>
        <div class="muted" style="margin-top:8px; line-height:1.7;">
          錯誤訊息：<span class="kbd">${escapeHtml(msg)}</span>
        </div>
      `;
    }
  }

  btnPrev.addEventListener("click", prev);
  btnNext.addEventListener("click", next);
  btnReveal.addEventListener("click", reveal);
  btnSubmit.addEventListener("click", () => submitNow(false));
  btnReset.addEventListener("click", resetProgress);
  btnRetry.addEventListener("click", init);

  btnShuffle.addEventListener("click", () => setOrder("shuffled"));
  btnOrdered.addEventListener("click", () => setOrder("ordered"));

  modePractice.addEventListener("click", () => setMode("practice"));
  modeExam.addEventListener("click", () => setMode("exam"));

  btnT60.addEventListener("click", () => setExamDuration(60));
  btnT90.addEventListener("click", () => setExamDuration(90));
  btnT120.addEventListener("click", () => setExamDuration(120));

  btnStartWrong.addEventListener("click", () => {
    startNewSession("wrong");
    const ok = drawWrong();
    if(!ok){
      state.session = "normal";
      saveState();
      toast("錯題本空，回到一般測驗");
      drawNormal();
    }
    buildViewOrder();
    setStatus("錯題重測", "ok");
    render();
    startTimerIfNeeded();
  });

  btnClearWrong.addEventListener("click", clearWrongBook);

  btnShowAll.addEventListener("click", () => setFilter("all"));
  btnShowWrong.addEventListener("click", () => setFilter("wrong"));
  btnShowUnanswered.addEventListener("click", () => setFilter("unanswered"));

  window.addEventListener("keydown", (e) => {
    if(e.key === "ArrowLeft") prev();
    if(e.key === "ArrowRight") next();
    if(e.key.toLowerCase() === "a") reveal();
    if(e.key.toLowerCase() === "s") submitNow(false);

    const n = Number(e.key);
    if(Number.isInteger(n) && n >= 1 && n <= 9){
      const q = currentQuestion();
      if(q && n <= q.options.length) onChoose(n - 1);
    }
  });

  init();
})();
</script>
</body>
</html>
